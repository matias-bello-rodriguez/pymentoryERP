<div class="container-fluid main-container">
  <!-- Header -->
  <app-navbar></app-navbar>

  <div class="container">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 mt-4">
      <div>
        <h2 class="mb-1">
          <i class="fas fa-university text-primary me-2"></i>Gestión de Bancos
        </h2>
        <p class="text-muted mb-0">Administra cuentas bancarias y movimientos</p>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary btn-custom" (click)="showNewBankAccountModal()">
          <i class="fas fa-plus me-2"></i>Nueva Cuenta
        </button>
        <button class="btn btn-success btn-custom" (click)="showNewMovementModal()">
          <i class="fas fa-exchange-alt me-2"></i>Nuevo Movimiento
      </button>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card card-custom bg-primary text-white">
        <div class="card-body text-center">
          <i class="fas fa-university fa-2x mb-2"></i>
          <h4>{{bankAccounts.length}}</h4>
          <p class="mb-0">Cuentas Bancarias</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-custom bg-success text-white">
        <div class="card-body text-center">
          <i class="fas fa-coins fa-2x mb-2"></i>
          <h4>{{formatCurrency(getTotalBalance())}}</h4>
          <p class="mb-0">Balance Total</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-custom bg-info text-white">
        <div class="card-body text-center">
          <i class="fas fa-list fa-2x mb-2"></i>
          <h4>{{filteredMovements.length}}</h4>
          <p class="mb-0">Movimientos</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-custom bg-warning text-white">
        <div class="card-body text-center">
          <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
          <h4>{{getUnreconciledCount()}}</h4>
          <p class="mb-0">Sin Conciliar</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Bank Account Form -->
  <div class="card card-custom mb-4" *ngIf="showBankForm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="fas fa-edit me-2"></i>
        {{isEditingBank ? 'Editar Cuenta Bancaria' : 'Nueva Cuenta Bancaria'}}
      </h5>
    </div>
    <div class="card-body">
      <form [formGroup]="bankForm" (ngSubmit)="onSubmitBank()">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Banco *</label>
            <input 
              type="text" 
              class="form-control"
              formControlName="bankName"
              placeholder="Nombre del banco"
              [class.is-invalid]="bankForm.get('bankName')?.invalid && bankForm.get('bankName')?.touched"
            >
            <div class="invalid-feedback" *ngIf="bankForm.get('bankName')?.errors && bankForm.get('bankName')?.touched">
              <div *ngIf="bankForm.get('bankName')?.errors?.['required']">El nombre del banco es requerido</div>
              <div *ngIf="bankForm.get('bankName')?.errors?.['minlength']">Mínimo 3 caracteres</div>
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Nombre de la Cuenta *</label>
            <input 
              type="text" 
              class="form-control"
              formControlName="accountName"
              placeholder="Nombre descriptivo"
              [class.is-invalid]="bankForm.get('accountName')?.invalid && bankForm.get('accountName')?.touched"
            >
            <div class="invalid-feedback" *ngIf="bankForm.get('accountName')?.errors && bankForm.get('accountName')?.touched">
              <div *ngIf="bankForm.get('accountName')?.errors?.['required']">El nombre de la cuenta es requerido</div>
              <div *ngIf="bankForm.get('accountName')?.errors?.['minlength']">Mínimo 3 caracteres</div>
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Número de Cuenta *</label>
            <input 
              type="text" 
              class="form-control"
              formControlName="accountNumber"
              placeholder="000-123456-78"
              [class.is-invalid]="bankForm.get('accountNumber')?.invalid && bankForm.get('accountNumber')?.touched"
            >
            <div class="invalid-feedback" *ngIf="bankForm.get('accountNumber')?.errors && bankForm.get('accountNumber')?.touched">
              <div *ngIf="bankForm.get('accountNumber')?.errors?.['required']">El número de cuenta es requerido</div>
              <div *ngIf="bankForm.get('accountNumber')?.errors?.['pattern']">Solo números y guiones</div>
            </div>
          </div>

          <div class="col-md-3">
            <label class="form-label">Tipo de Cuenta *</label>
            <select 
              class="form-select"
              formControlName="accountType"
              [class.is-invalid]="bankForm.get('accountType')?.invalid && bankForm.get('accountType')?.touched"
            >
              <option value="">Seleccionar</option>
              <option *ngFor="let type of bankAccountTypes" [value]="type">
                {{getBankAccountTypeName(type)}}
              </option>
            </select>
            <div class="invalid-feedback" *ngIf="bankForm.get('accountType')?.errors && bankForm.get('accountType')?.touched">
              El tipo de cuenta es requerido
            </div>
          </div>

          <div class="col-md-2">
            <label class="form-label">Moneda *</label>
            <select class="form-select" formControlName="currency">
              <option value="COP">COP</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">Balance Inicial *</label>
            <input 
              type="number" 
              class="form-control"
              formControlName="balance"
              placeholder="0.00"
              step="0.01"
              [class.is-invalid]="bankForm.get('balance')?.invalid && bankForm.get('balance')?.touched"
            >
            <div class="invalid-feedback" *ngIf="bankForm.get('balance')?.errors && bankForm.get('balance')?.touched">
              <div *ngIf="bankForm.get('balance')?.errors?.['required']">El balance es requerido</div>
              <div *ngIf="bankForm.get('balance')?.errors?.['min']">El balance no puede ser negativo</div>
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Estado</label>
            <div class="form-check form-switch mt-2">
              <input 
                class="form-check-input" 
                type="checkbox" 
                formControlName="isActive"
                id="bankIsActive"
              >
              <label class="form-check-label" for="bankIsActive">
                Cuenta Activa
              </label>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-success" [disabled]="bankForm.invalid">
            <i class="fas fa-save me-2"></i>
            {{isEditingBank ? 'Actualizar' : 'Guardar'}}
          </button>
          <button type="button" class="btn btn-secondary" (click)="cancelBankEdit()">
            <i class="fas fa-times me-2"></i>Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Movement Form -->
  <div class="card card-custom mb-4" *ngIf="showMovementForm">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0">
        <i class="fas fa-edit me-2"></i>
        {{isEditingMovement ? 'Editar Movimiento' : 'Nuevo Movimiento'}}
      </h5>
    </div>
    <div class="card-body">
      <form [formGroup]="movementForm" (ngSubmit)="onSubmitMovement()">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Cuenta Bancaria *</label>
            <select 
              class="form-select"
              formControlName="bankAccountId"
              [class.is-invalid]="movementForm.get('bankAccountId')?.invalid && movementForm.get('bankAccountId')?.touched"
            >
              <option value="">Seleccionar cuenta</option>
              <option *ngFor="let account of bankAccounts" [value]="account.id">
                {{account.bankName}} - {{account.accountNumber}} ({{formatCurrency(account.balance)}})
              </option>
            </select>
            <div class="invalid-feedback" *ngIf="movementForm.get('bankAccountId')?.errors && movementForm.get('bankAccountId')?.touched">
              La cuenta bancaria es requerida
            </div>
          </div>

          <div class="col-md-3">
            <label class="form-label">Fecha *</label>
            <input 
              type="date" 
              class="form-control"
              formControlName="date"
              [class.is-invalid]="movementForm.get('date')?.invalid && movementForm.get('date')?.touched"
            >
            <div class="invalid-feedback" *ngIf="movementForm.get('date')?.errors && movementForm.get('date')?.touched">
              La fecha es requerida
            </div>
          </div>

          <div class="col-md-3">
            <label class="form-label">Tipo *</label>
            <select 
              class="form-select"
              formControlName="type"
              [class.is-invalid]="movementForm.get('type')?.invalid && movementForm.get('type')?.touched"
            >
              <option value="">Seleccionar</option>
              <option *ngFor="let type of movementTypes" [value]="type">
                {{getMovementTypeName(type)}}
              </option>
            </select>
            <div class="invalid-feedback" *ngIf="movementForm.get('type')?.errors && movementForm.get('type')?.touched">
              El tipo es requerido
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Descripción *</label>
            <input 
              type="text" 
              class="form-control"
              formControlName="description"
              placeholder="Descripción del movimiento"
              [class.is-invalid]="movementForm.get('description')?.invalid && movementForm.get('description')?.touched"
            >
            <div class="invalid-feedback" *ngIf="movementForm.get('description')?.errors && movementForm.get('description')?.touched">
              <div *ngIf="movementForm.get('description')?.errors?.['required']">La descripción es requerida</div>
              <div *ngIf="movementForm.get('description')?.errors?.['minlength']">Mínimo 3 caracteres</div>
            </div>
          </div>

          <div class="col-md-3">
            <label class="form-label">Monto *</label>
            <input 
              type="number" 
              class="form-control"
              formControlName="amount"
              placeholder="0.00"
              step="0.01"
              min="0"
              [class.is-invalid]="movementForm.get('amount')?.invalid && movementForm.get('amount')?.touched"
            >
            <div class="invalid-feedback" *ngIf="movementForm.get('amount')?.errors && movementForm.get('amount')?.touched">
              <div *ngIf="movementForm.get('amount')?.errors?.['required']">El monto es requerido</div>
              <div *ngIf="movementForm.get('amount')?.errors?.['min']">El monto debe ser mayor a 0</div>
            </div>
          </div>

          <div class="col-md-3">
            <label class="form-label">Referencia</label>
            <input 
              type="text" 
              class="form-control"
              formControlName="reference"
              placeholder="Número de referencia"
            >
          </div>

          <div class="col-md-12">
            <div class="form-check">
              <input 
                class="form-check-input" 
                type="checkbox" 
                formControlName="isReconciled"
                id="isReconciled"
              >
              <label class="form-check-label" for="isReconciled">
                Movimiento Conciliado
              </label>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-success" [disabled]="movementForm.invalid">
            <i class="fas fa-save me-2"></i>
            {{isEditingMovement ? 'Actualizar' : 'Guardar'}}
          </button>
          <button type="button" class="btn btn-secondary" (click)="cancelMovementEdit()">
            <i class="fas fa-times me-2"></i>Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bank Accounts Table -->
  <div class="card card-custom mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="fas fa-table me-2"></i>Cuentas Bancarias
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-dark">
            <tr>
              <th>Banco</th>
              <th>Cuenta</th>
              <th>Número</th>
              <th>Tipo</th>
              <th class="text-end">Balance</th>
              <th class="text-center">Estado</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let account of bankAccounts" [class]="!account.isActive ? 'table-secondary' : ''">
              <td>
                <strong>{{account.bankName}}</strong>
              </td>
              <td>{{account.accountName}}</td>
              <td>
                <code>{{account.accountNumber}}</code>
              </td>
              <td>
                <span class="badge bg-info">{{getBankAccountTypeName(account.accountType)}}</span>
              </td>
              <td class="text-end">
                <strong [class]="account.balance >= 0 ? 'text-success' : 'text-danger'">
                  {{formatCurrency(account.balance)}}
                </strong>
              </td>
              <td class="text-center">
                <span 
                  class="badge"
                  [class]="account.isActive ? 'bg-success' : 'bg-secondary'"
                >
                  {{account.isActive ? 'Activa' : 'Inactiva'}}
                </span>
              </td>
              <td class="text-center">
                <div class="btn-group btn-group-sm">
                  <button 
                    class="btn btn-outline-primary" 
                    (click)="editBankAccount(account)"
                    title="Editar"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button 
                    class="btn btn-outline-warning" 
                    (click)="toggleAccountStatus(account.id)"
                    [title]="account.isActive ? 'Desactivar' : 'Activar'"
                  >
                    <i class="fas" [class]="account.isActive ? 'fa-eye-slash' : 'fa-eye'"></i>
                  </button>
                  <button 
                    class="btn btn-outline-danger" 
                    (click)="deleteBankAccount(account.id)"
                    title="Eliminar"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Movement Filters -->
  <div class="card card-custom mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="fas fa-filter me-2"></i>Filtros de Movimientos
      </h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Cuenta</label>
          <select class="form-select" [(ngModel)]="selectedBankId" (change)="applyMovementFilters()">
            <option value="">Todas las cuentas</option>
            <option *ngFor="let account of bankAccounts" [value]="account.id">
              {{account.bankName}} - {{account.accountNumber}}
            </option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Tipo</label>
          <select class="form-select" [(ngModel)]="filterType" (change)="applyMovementFilters()">
            <option value="">Todos</option>
            <option *ngFor="let type of movementTypes" [value]="type">
              {{getMovementTypeName(type)}}
            </option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha Desde</label>
          <input type="date" class="form-control" [(ngModel)]="filterDateFrom" (change)="applyMovementFilters()">
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha Hasta</label>
          <input type="date" class="form-control" [(ngModel)]="filterDateTo" (change)="applyMovementFilters()">
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <button 
            class="btn btn-outline-secondary w-100" 
            (click)="selectedBankId = ''; filterType = ''; filterDateFrom = ''; filterDateTo = ''; applyMovementFilters()"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bank Movements Table -->
  <div class="card card-custom">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="fas fa-table me-2"></i>Movimientos Bancarios
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-dark">
            <tr>
              <th>Fecha</th>
              <th>Cuenta</th>
              <th>Descripción</th>
              <th>Tipo</th>
              <th class="text-end">Monto</th>
              <th class="text-end">Balance</th>
              <th class="text-center">Conciliado</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let movement of filteredMovements">
              <td>
                <small>{{formatDate(movement.date)}}</small>
              </td>
              <td>
                <small>{{getBankAccountName(movement.bankAccountId)}}</small>
              </td>
              <td>
                <strong>{{movement.description}}</strong>
                <br>
                <small class="text-muted">{{movement.reference}}</small>
              </td>
              <td>
                <span class="badge bg-secondary">{{getMovementTypeName(movement.type)}}</span>
              </td>
              <td class="text-end">
                <strong>{{formatCurrency(movement.amount)}}</strong>
              </td>
              <td class="text-end">
                <strong [class]="movement.balance >= 0 ? 'text-success' : 'text-danger'">
                  {{formatCurrency(movement.balance)}}
                </strong>
              </td>
              <td class="text-center">
                <button 
                  class="btn btn-sm"
                  [class]="movement.isReconciled ? 'btn-success' : 'btn-outline-warning'"
                  (click)="toggleReconciliation(movement.id)"
                >
                  <i class="fas" [class]="movement.isReconciled ? 'fa-check' : 'fa-clock'"></i>
                </button>
              </td>
              <td class="text-center">
                <div class="btn-group btn-group-sm">
                  <button 
                    class="btn btn-outline-primary" 
                    (click)="editMovement(movement)"
                    title="Editar"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button 
                    class="btn btn-outline-danger" 
                    (click)="deleteMovement(movement.id)"
                    title="Eliminar"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="filteredMovements.length === 0" class="text-center py-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <p class="text-muted">No se encontraron movimientos</p>
      </div>
    </div>
  </div>
</div>
</div>