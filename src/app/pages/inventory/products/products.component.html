<div class="container-fluid main-container">
  <!-- Header -->
  <app-navbar></app-navbar>

  <div class="container">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 mt-4">
      <div>
        <h2 class="mb-1">
          <i class="fas fa-warehouse text-primary me-2"></i>Inventario / Stock
        </h2>
        <p class="text-muted mb-0">Control de productos, entradas y salidas, stock mínimo y máximo</p>
      </div>
      <button class="btn btn-primary btn-custom" (click)="showForm = !showForm">
        <i class="fas fa-plus me-2"></i>Nuevo Producto
      </button>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card card-custom bg-primary text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 class="mb-0">{{totalProducts}}</h4>
                <p class="mb-0">Total Productos</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-boxes fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card card-custom bg-success text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 class="mb-0">{{formatCurrency(totalValue)}}</h4>
                <p class="mb-0">Valor Total</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-euro-sign fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card card-custom bg-warning text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 class="mb-0">{{lowStockCount}}</h4>
                <p class="mb-0">Stock Bajo</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card card-custom bg-danger text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 class="mb-0">{{outOfStockCount}}</h4>
                <p class="mb-0">Sin Stock</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-times-circle fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alerts Section -->
    <div class="row mb-4" *ngIf="alerts.length > 0">
      <div class="col-12">
        <div class="card card-custom">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
              <i class="fas fa-bell me-2"></i>Alertas de Inventario ({{alerts.length}})
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6" *ngFor="let alert of alerts.slice(0, 4)">
                <div class="alert" [class]="'alert-' + (alert.severity === 'CRITICAL' ? 'danger' : alert.severity === 'HIGH' ? 'warning' : alert.severity === 'MEDIUM' ? 'info' : 'secondary')" 
                     [class.alert-dismissible]="!alert.acknowledged">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong>{{alert.productCode}}</strong> - {{alert.message}}
                      <br>
                      <small class="text-muted">Stock actual: {{alert.currentStock}}</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-dark" 
                            (click)="acknowledgeAlert(alert)" 
                            *ngIf="!alert.acknowledged">
                      <i class="fas fa-check"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Form -->
    <div class="row mb-4" *ngIf="showForm">
      <div class="col-12">
        <div class="card card-custom">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
              <i class="fas fa-plus me-2"></i>{{editingProduct ? 'Editar' : 'Nuevo'}} Producto
            </h5>
          </div>
          <div class="card-body">
            <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">Código *</label>
                  <input type="text" class="form-control" formControlName="code" 
                         [class.is-invalid]="productForm.get('code')?.invalid && productForm.get('code')?.touched">
                  <div class="invalid-feedback">
                    El código es requerido (mínimo 3 caracteres)
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Nombre *</label>
                  <input type="text" class="form-control" formControlName="name"
                         [class.is-invalid]="productForm.get('name')?.invalid && productForm.get('name')?.touched">
                  <div class="invalid-feedback">
                    El nombre es requerido (mínimo 2 caracteres)
                  </div>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Estado *</label>
                  <select class="form-select" formControlName="status">
                    <option [value]="ProductStatus.ACTIVE">Activo</option>
                    <option [value]="ProductStatus.INACTIVE">Inactivo</option>
                    <option [value]="ProductStatus.DISCONTINUED">Descontinuado</option>
                  </select>
                </div>

                <div class="col-md-12">
                  <label class="form-label">Descripción</label>
                  <textarea class="form-control" formControlName="description" rows="2"></textarea>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Categoría *</label>
                  <select class="form-select" formControlName="category"
                          [class.is-invalid]="productForm.get('category')?.invalid && productForm.get('category')?.touched">
                    <option value="">Seleccionar categoría</option>
                    <option [value]="ProductCategory.ELECTRONICS">Electrónicos</option>
                    <option [value]="ProductCategory.CLOTHING">Ropa</option>
                    <option [value]="ProductCategory.FOOD">Alimentos</option>
                    <option [value]="ProductCategory.BOOKS">Libros</option>
                    <option [value]="ProductCategory.HOME">Hogar</option>
                    <option [value]="ProductCategory.TOOLS">Herramientas</option>
                    <option [value]="ProductCategory.HEALTH">Salud</option>
                    <option [value]="ProductCategory.SPORTS">Deportes</option>
                    <option [value]="ProductCategory.OTHER">Otros</option>
                  </select>
                  <div class="invalid-feedback">
                    La categoría es requerida
                  </div>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Unidad de Medida *</label>
                  <select class="form-select" formControlName="unitOfMeasure"
                          [class.is-invalid]="productForm.get('unitOfMeasure')?.invalid && productForm.get('unitOfMeasure')?.touched">
                    <option value="">Seleccionar unidad</option>
                    <option [value]="UnitOfMeasure.UNIT">Unidad</option>
                    <option [value]="UnitOfMeasure.KG">Kilogramo</option>
                    <option [value]="UnitOfMeasure.LITER">Litro</option>
                    <option [value]="UnitOfMeasure.METER">Metro</option>
                    <option [value]="UnitOfMeasure.BOX">Caja</option>
                    <option [value]="UnitOfMeasure.PACK">Paquete</option>
                  </select>
                  <div class="invalid-feedback">
                    La unidad de medida es requerida
                  </div>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Ubicación</label>
                  <input type="text" class="form-control" formControlName="location" placeholder="Ej: Almacén A-01">
                </div>

                <div class="col-md-3">
                  <label class="form-label">Costo Unitario *</label>
                  <div class="input-group">
                    <span class="input-group-text">€</span>
                    <input type="number" class="form-control" formControlName="unitCost" min="0" step="0.01"
                           [class.is-invalid]="productForm.get('unitCost')?.invalid && productForm.get('unitCost')?.touched">
                  </div>
                  <div class="invalid-feedback">
                    El costo debe ser mayor o igual a 0
                  </div>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Precio de Venta *</label>
                  <div class="input-group">
                    <span class="input-group-text">€</span>
                    <input type="number" class="form-control" formControlName="unitPrice" min="0" step="0.01"
                           [class.is-invalid]="productForm.get('unitPrice')?.invalid && productForm.get('unitPrice')?.touched">
                  </div>
                  <div class="invalid-feedback">
                    El precio debe ser mayor o igual a 0
                  </div>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Stock Actual *</label>
                  <input type="number" class="form-control" formControlName="currentStock" min="0"
                         [class.is-invalid]="productForm.get('currentStock')?.invalid && productForm.get('currentStock')?.touched">
                  <div class="invalid-feedback">
                    El stock debe ser mayor o igual a 0
                  </div>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Proveedor</label>
                  <input type="text" class="form-control" formControlName="supplier">
                </div>

                <div class="col-md-3">
                  <label class="form-label">Stock Mínimo *</label>
                  <input type="number" class="form-control" formControlName="minStock" min="0"
                         [class.is-invalid]="productForm.get('minStock')?.invalid && productForm.get('minStock')?.touched">
                  <div class="invalid-feedback">
                    El stock mínimo debe ser mayor o igual a 0
                  </div>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Stock Máximo *</label>
                  <input type="number" class="form-control" formControlName="maxStock" min="0"
                         [class.is-invalid]="productForm.get('maxStock')?.invalid && productForm.get('maxStock')?.touched">
                  <div class="invalid-feedback">
                    El stock máximo debe ser mayor o igual a 0
                  </div>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Punto de Reorden *</label>
                  <input type="number" class="form-control" formControlName="reorderPoint" min="0"
                         [class.is-invalid]="productForm.get('reorderPoint')?.invalid && productForm.get('reorderPoint')?.touched">
                  <div class="invalid-feedback">
                    El punto de reorden debe ser mayor o igual a 0
                  </div>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Código de Barras</label>
                  <input type="text" class="form-control" formControlName="barcode">
                </div>
              </div>

              <div class="mt-4">
                <button type="submit" class="btn btn-primary me-2" [disabled]="productForm.invalid">
                  <i class="fas fa-save me-2"></i>{{editingProduct ? 'Actualizar' : 'Guardar'}}
                </button>
                <button type="button" class="btn btn-secondary" (click)="resetForm()">
                  <i class="fas fa-times me-2"></i>Cancelar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card card-custom">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Buscar</label>
                <input type="text" class="form-control" [(ngModel)]="searchTerm" 
                       (input)="applyFilters()" placeholder="Buscar por código, nombre o descripción...">
              </div>
              <div class="col-md-2">
                <label class="form-label">Categoría</label>
                <select class="form-select" [(ngModel)]="categoryFilter" (change)="applyFilters()">
                  <option value="">Todas</option>
                  <option [value]="ProductCategory.ELECTRONICS">Electrónicos</option>
                  <option [value]="ProductCategory.CLOTHING">Ropa</option>
                  <option [value]="ProductCategory.FOOD">Alimentos</option>
                  <option [value]="ProductCategory.BOOKS">Libros</option>
                  <option [value]="ProductCategory.HOME">Hogar</option>
                  <option [value]="ProductCategory.TOOLS">Herramientas</option>
                  <option [value]="ProductCategory.HEALTH">Salud</option>
                  <option [value]="ProductCategory.SPORTS">Deportes</option>
                  <option [value]="ProductCategory.OTHER">Otros</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Estado</label>
                <select class="form-select" [(ngModel)]="statusFilter" (change)="applyFilters()">
                  <option value="">Todos</option>
                  <option [value]="ProductStatus.ACTIVE">Activo</option>
                  <option [value]="ProductStatus.INACTIVE">Inactivo</option>
                  <option [value]="ProductStatus.DISCONTINUED">Descontinuado</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Stock</label>
                <select class="form-select" [(ngModel)]="stockFilter" (change)="applyFilters()">
                  <option value="">Todos</option>
                  <option value="out">Sin Stock</option>
                  <option value="low">Stock Bajo</option>
                  <option value="normal">Stock Normal</option>
                  <option value="high">Exceso</option>
                </select>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-secondary w-100" (click)="clearFilters()">
                  <i class="fas fa-eraser me-2"></i>Limpiar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Table -->
    <div class="row">
      <div class="col-12">
        <div class="card card-custom">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
              <i class="fas fa-list me-2"></i>Lista de Productos ({{filteredProducts.length}})
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Categoría</th>
                    <th>Stock</th>
                    <th>Estado Stock</th>
                    <th>Costo</th>
                    <th>Precio</th>
                    <th>Valor Total</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let product of filteredProducts">
                    <td>
                      <strong>{{product.code}}</strong>
                      <br>
                      <small class="text-muted" *ngIf="product.barcode">{{product.barcode}}</small>
                    </td>
                    <td>
                      <div class="d-flex align-items-center">
                        <i [class]="getCategoryIcon(product.category)" class="me-2 text-primary"></i>
                        <div>
                          <strong>{{product.name}}</strong>
                          <br>
                          <small class="text-muted">{{product.description}}</small>
                          <br>
                          <small class="text-muted" *ngIf="product.location">
                            <i class="fas fa-map-marker-alt me-1"></i>{{product.location}}
                          </small>
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="badge bg-secondary">{{product.category}}</span>
                      <br>
                      <small class="text-muted">{{product.unitOfMeasure}}</small>
                    </td>
                    <td>
                      <span [class]="getStockStatusClass(product)">
                        <strong>{{product.currentStock}}</strong>
                      </span>
                      <br>
                      <small class="text-muted">
                        Min: {{product.minStock}} / Max: {{product.maxStock}}
                      </small>
                      <br>
                      <small class="text-muted">
                        Reorden: {{product.reorderPoint}}
                      </small>
                    </td>
                    <td>
                      <span class="badge" 
                            [class]="'bg-' + (product.currentStock === 0 ? 'danger' : product.currentStock <= product.minStock ? 'warning' : product.currentStock >= product.maxStock ? 'info' : 'success')">
                        {{getStockStatusText(product)}}
                      </span>
                    </td>
                    <td>{{formatCurrency(product.unitCost)}}</td>
                    <td>{{formatCurrency(product.unitPrice)}}</td>
                    <td>
                      <strong>{{formatCurrency(product.currentStock * product.unitCost)}}</strong>
                      <br>
                      <small class="text-muted">
                        Margen: {{(((product.unitPrice - product.unitCost) / product.unitCost) * 100).toFixed(1)}}%
                      </small>
                    </td>
                    <td>
                      <span class="badge" 
                            [class]="'bg-' + (product.status === ProductStatus.ACTIVE ? 'success' : product.status === ProductStatus.INACTIVE ? 'warning' : 'danger')">
                        {{product.status === ProductStatus.ACTIVE ? 'Activo' : product.status === ProductStatus.INACTIVE ? 'Inactivo' : 'Descontinuado'}}
                      </span>
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" (click)="editProduct(product)" title="Editar">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" (click)="deleteProduct(product)" title="Eliminar">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div *ngIf="filteredProducts.length === 0" class="text-center py-5">
              <i class="fas fa-box fa-3x text-muted mb-3"></i>
              <p class="text-muted">No se encontraron productos</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>